# Мысли о хранении данных

## Версия 1 - как было

Первая версия omoide была по сути отражением файловой системы. Я предполагал,
что это будет система похожая на git: пользователи скачивают к себе
"репозиторий", делают "коммит" (добавляют новый контент) и потом загружают
изменения в центральное хранилище. Сейчас я понимаю, что пользователи ленивые и
даже по ссылке просто так переходить не будут, но всё-же какое-то время
парадигма файловой системы оставалась актуальной.

Хранение было организовано в каталогах следующим образом:

```
root
  └── theme1
        ├── group1
        └── group2
               └── 18b5c8d1-eb2b-42a8-b71a-471f95679e7d___cat.jpg
```

Т.е. был корневой каталог, в нём темы, в темах группы, а в группах картинки.

Эта схема на первый взгляд кажется логичной, но на практике порождает целый
ворох проблем.

Самые поверхностные из них:

1. Что делать с именами на кириллице?
    - Была написана функция-конвертер, преобразующую кириллицу в латиницу.
    - Что делать с заглавными буквами? Менять регистр на маленький.
    - Что делать со спецсимволами? Удалять.
    - Функция-преобразователь это по итогу хеш функция, зная латинское название
      каталога нельзя провернуть его обратно и получить кириллицу.
2. Надо хранить всё дерево путей.
    - Долгое время сервис работал как конвертер
      "локальное хранилище" -> "сайт". Соответственно строилось дублирующее
      дерево, повторяющее структуру каталогов исходной папки. Поскольку в
      системе несколько форматов хранения данных, для каждого из них надо
      делать своё дерево.
3. При перемещении файлов или каталогов в другое место нужен особый ритуальный
   танец.
4. Сама по себе такая структура крайне жёсткая и совсем не сочетается с поиском
   по тегам.

Одна из основных идей, которая диктовала подобную структуру - возможность
просто скачать себе весь архив с картинками и смотреть его у себя на
компьютере, вообще не используя для этого никаких сторонних программ. Но по
мере увеличение размера хранилища стало понятно, что это бессмысленно. Архив
просто-напросто получается слишком большим. С имеющимся железом я имею ёмкость
в 450 ГБ, что явно за пределами разумного для варианта "просто скачать архив и
смотреть картинки в нём".

## Версия 2 - как стало

Храним также в каталогах, но схема более простая.

```
root
  └── 559a52e2-2d97-4e81-a699-af47c0ce79e2 (пользователь)
        ├── content
        ├── preview
        └── thumbnail
               ├── 00
               │   ├── 0003050f-ee5d-47ef-83ae-19cc97bfc49a.jpg
               │   ├── 0005090b-e13c-4c37-b545-531cd43d57a2.jpg
               │   └── 0005e256-3218-43cf-8815-63c19da91d22.jpg
               └── 01
                   ├── 010352e5-f2c5-4fc4-ad61-b63280dbf04b.jpg
                   └── 010510df-259b-443b-a196-b25d52123f2e.jpg
```

Каждому пользователю выделено по каталогу, в котором он может резвиться как
хочет. Под каждый тип контента по-прежнему выделяется каталог, только теперь он
по сути плоский.

Подкаталоги с именем из двух символов это просто оптимизация для работы
файловой системы. Они берутся из первых двух символов uuid. Их смысл - снизить
общее количество файлов в одном каталоге. Будь у меня доступ к более
совершенной системе хранения, например к S3, хранение можно было бы
организовать в едином пространстве имён (для пары пользователь-тип контента).

Выделение одного символа делит весь банк файлов на 16 ячеек. Соответственно два
символа это 256 ячеек или 256 каталогов. Это достаточно небольшое число
каталогов, которое будет создано очень быстро после начала загрузки данных в
систему. Добавление ещё одного символа доводит число папок до 4096, что для
почти пустого хранилища многовато.

Сейчас в хранилище 33 тысячи файлов и среднее заполнение одного такого "бакета"
составляет примерно 150 файлов. Я ориентируюсь примерно на 1000 файлов на
каталог, этот лимит будет достигнут примерно на ёмкости 200 тысяч файлов. Если
потом начнутся проблемы с производительностью, можно будет выделить ещё один
символ на "бакет" и переложить все файлы.

Такая система удобна отсутствием иерархии между файлами. Она (иерархия)
задаётся в другом месте и может быть произвольной, её даже может быть больше
одной. Если менять иерархию и перекладывать записи из одной группы в другую,
это не потребует физического перемещения файлов. Пропадает проблема длинных
путей и нескольких уровней вложенности, доступ ко всем файлам унифицирован.

Да, мы теряем возможность просто пойти и посмотреть, что там хранится в той или
иной группе. Но при таких количествах файлов это уже теряет всякий смысл.

## Как заводить файлы в систему

Долгое время я не хотел отказываться от идеи зеркалирования локального каталога
на сайт. На первый взгляд это выглядит логично - сделай цепочку каталогов и
храни в них файлы. При преобразовании цепочка станет иерархией, а файлы
автоматически разложатся по папкам. Правда остаётся проблема в том, что надо
мониторить состояние всего дерева, видеть новые файлы, обрабатывать только
добавленные. Конечно было бы неплохо иметь папку "Фото", складывать туда новые
фотографии год за годом и видеть как они красиво перетекают в хранилище.

Но у этой системы есть минусы:

1. Надо держать в порядке каталог с файлами.
2. Если я задумаю поменять иерархию и переложить файлы из одного каталога в
   другой, система загрузки должна провести весьма нетривиальные вычисления,
   чтобы это увидеть.
3. Самое главное - надо написать код, который будет заниматься этим
   перекладыванием.

Последняя проблема не кажется такой уж неожиданной, но по факту она самая
сложная. Предыдущая версия как раз таки имела такой загрузчик. Практика
показала, что объём кода загрузчика и объем кода приложения соотносятся
примерно как 80%/20%. Т.е. большую часть времени я пишу загрузчик. А самое
плохое, что он никак не масштабируется - он будет использоваться только мной, в
то время как для пользователей надо будет писать свою систему загрузки (
написание которой постоянно откладывается т.к. текущий загрузчик тоже ещё не
готов на 100%).

Поэтому я решил сосредоточиться на общем для всех методе загрузки и не писать
чисто под себя ускоренный. Минус проявится в том, что мой локальный каталог с
контентом превратится в помойку. Не особо большая проблема, зато написав эту
систему один раз, я получу возможность предоставить его всем пользователям
разом. Таким образом можно будет сразу получить масштабирование для тысяч
пользователей вместо того, чтобы удобно загружать данные мне одному.
