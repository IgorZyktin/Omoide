# Мысли об организации поиска

Вся идея omoide крутится вокруг того, что нужно быстро шерстить огромные объёмы
медиа материалов. Для этого их надо искать по тегам. Но варианты поиска
отличаются.

Вводим "кошки" и получаем все записи с тегом "кошки".

Но если мы анонимус, нам нельзя показывать персональные фото пользователей с их
кошками. По соображениям безопасности, на первых порах предполагается, что
пользователь не может выставлять свои картинки публично. Это доступно только
специально оговоренным публичным пользователям. Выдача должна содержать только
тех кошек, которые есть у публичных пользователей.

Кроме того, у пользователя в настройках могут быть включены ограничения. Они
предполагаются как некоторые группы видимости, например группа "фотографии
родственников", в которой есть три альбома от разных владельцев. В любой момент
пользователь может переключить видимость на вариант "спортивный инвентарь", где
выбраны уже совсем другие альбомы.

## Логика поиска для анонимуса

Искать по картинкам только у публичных пользователей. Анонимные пользователи не
могут создавать для себя группы видимости, поэтому никаких других вариантов
поиска у них нет.

Вероятно физически нет смысла создавать группу public, можно просто имитировать
её, а искать просто по пользователям с особым uuid. Предполагается, что
публичные пользователи не могут иметь закрытых альбомом, а обычные пользователи
не могут публиковать материал для всех подряд. Это всё средство защиты от
пользователей, которые будут загружать Гитлера совестно с лолями.

## Логика предоставления доступа к своим материалам

Рассмотрим пример на стандартных пользователях - Алисе и Бобе. У Боба файлов
нет, а у Алисы есть.

Структура хранения:

```
Алиса
  ├── Альбом-1 (id-1)
  │     ├── Картинка-1 (id-2)
  │     ├── Картинка-2 (id-3)
  │     ├── Картинка-3 (id-4)
  │     └── Картинка-4 (id-5)
  └── Альбом-2 (id-6)
        ├── Картинка-5 (id-7)
        └── Картинка-6 (id-8)
```

Предположим, Алиса хочет дать доступ ко всему в альбоме №2 (id-6) и к первым
двум картинкам в альбоме №1 (id-2 и id-3). Доступ даётся к конкретной записи,
если дать доступ к альбому, всё что можно будет сделать это посмотреть его
обложку. В момент загрузки у пользователя надо спросить, расширить ли права
доступа на все дочерние записи (1 уровень или на всю глубину). Аналогично при
переключении родительской записи и при отзыве прав на просмотр.

Важные следствия:

1. Если загрузить материалы в расшаренный альбом, видеть их никто не сможет.
   Доступ надо будет давать для каждой новой картинки.
2. Если есть цепочка альбом1 -> альбом2 -> картинка, а доступ дан только к
   альбом1 и картинке, часть вариантов будет не видна при просмотре в виде
   каталогов. Поиск, впрочем, сможет найти такие картинки.

Чтобы не порождать декартово произведение всех пользователей на всех
пользователей для установки прав просмотра, следует ограничить доступ
коллективно. Например, Алиса создаст две категории доступа - "Семья"
и "Друзья".

| Альбом          | Запись            | Группа доступа |
| --------------- |-------------------|----------------|
| Альбом-1 (id-1) | Картинка-1 (id-2) | Друзья         |
| Альбом-1 (id-1) | Картинка-2 (id-3) | Друзья         |
| Альбом-2 (id-6) | -                 | Семья          |
| Альбом-2 (id-6) | Картинка-5 (id-7) | Семья          |
| Альбом-2 (id-6) | Картинка-6 (id-8) | Семья          |

С самого начала примем, что автоматическое расширение зоны доступа это зло.
Доступ должен поимённо выдаваться к каждой картинке. Если пользователь будет
догружать картинку в группу и хочет, чтобы другие их видели, его следует
спросить об этом на этапе загрузки.

Когда Алиса даст доступ к id-6, система должна спросить её, выдать ли доступ ко
всем вложенным записям (на 1 уровень вложенности или на всю глубину).

Нам удобно хранить id группы доступа в записи, но неудобно по ней искать.
Хотелось бы искать по id пользователя, который спрашивает. Тогда можно будет
быстро понять, имеет ли он право смотреть данную запись.

Логика следующая:

1. Добавляем запись.
2. Указываем, что её могут смотреть члены группы "семья", сохраняем это внутри
   записи.
3. Идём в группу "семья" и узнаём всех пользователей, которые в ней состоят.
   Всех их копируем в поле той таблицы, по которой будем искать (т.е. сохраняем
   это не в самой записи).

Так мы сможем быстро проверять права на просмотр.

## Логика поиска для зарегистрированного пользователя

Во-первых, стандартной группой видимости для них является публичная, дающая тот
же результат, что и поиск у анонимуса.

Во-вторых, у зарегистрированного пользователя должна быть группа private,
которая ищет по всем приватным пользователям и всем их записям.

В-третьих, у зарегистрированных пользователей должен быть механизм настройки
видимости. Должна быть возможность выбрать между "семейные утренники", "моя
сраная кошка" и "корпоративы".

Логика заполнения групп видимости должна отличаться от настройки прав доступа и
должна быть в целом проще. Поскольку мы неявно включаем в теги записей их
родителей, достаточно указывать только корневую запись. Если такая запись будет
добавлена в настройку, все её потомки будут включены автоматически.

Например, у Боба есть группа видимости "знакомые", в которую включён альбом
Алисы Альбом-2 (id-6).

Следствия из выбранного режима доступа:

1. Боб сможет искать и видеть как сам альбом, так и все вложенные в него на
   любую глубину записи (при условии, что Алиса дала такой доступ).
2. Если Алиса добавит в альбом новую запись и даст к ней доступ, Боб сразу
   сможет её увидеть.

Механизм настройки группы видимости это выбор id записей, которые обязательно
должны быть в него включены. Автоматически они потянут с собой и все дочерние.

Но при желании в группу можно поместить только несколько конечных записей, у
которых нет потомков.

Группы видимости будут проявляться при поиске по тегам и вообще при просмотре
альбомов, но не связаны напрямую с доступами.

Если хозяин записи решит ограничить к ней доступ, в группах видимости всех
пользователей она должна пропасть. Если получится такая ситуация, что владелец
удалил запись, а у кого-то она по ошибке осталась в группе видимости, ничего
страшного не произойдёт. Просто ничего не будет найдено.
