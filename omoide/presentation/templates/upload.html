{% extends "base_search.html" %}

{% block head %}
    <script type="text/javascript"
            src="{{ url_for('static', path='crud.js') }}"></script>
    <script type="text/javascript"
            src="{{ url_for('static', path='thirdparty/image-blob-reduce.min.js') }}"></script>
    <script type="text/javascript"
            src="{{ url_for('static', path='thirdparty/exif-js.min.js') }}"></script>
    <script type="text/javascript"
            src="{{ url_for('static', path='upload.js') }}"></script>
    <link type="text/css"
          href="{{ url_for('static', path='crud.css') }}"
          rel="stylesheet">
{% endblock %}

{% block body %}
    <div class="narrow-block">
        <h1>Upload media</h1>
        <label for="parent_uuid">Parent item (optional):
            <input id="parent_uuid"
                   type="text"
                   value="{{ parent_uuid }}"
                   class="height-auto"/>
        </label>

        <div id="parent_thumbnail" class="parent_thumbnail"></div>

        <label for="upload_as">Upload media in a way that:</label>
        <select id="upload_as">
            <option value="children">Every file is a new item</option>
            <option value="target">Only change parent item</option>
        </select>

        <label for="after_upload">After upload:</label>
        <select id="after_upload">
            <option value="parent">Go browse result</option>
            <option value="nothing">Do nothing (stay here)</option>
        </select>

        <label for="item_tags">Tags for new items (one tag per line):<br>
            <textarea id="item_tags" rows="10"></textarea>
        </label>

        <div>
            <input type="checkbox" id="feature-exif">
            <label for="feature-exif">Extract EXIF info (if uploading photos)</label>
        </div>

        <input type="file"
               id="upload-input"
               multiple
               accept=".jpg, .jpeg"
               onchange="addFiles(this)"/>

        <div id="alerts"></div>
    </div>

    <div class="narrow-block">
        <input id="preprocess_media_button"
               type="button"
               title="Preprocess media"
               class="button"
               value="Preprocess media">

        <input id="upload_media_button"
               type="button"
               title="Upload media"
               class="button"
               value="Upload media">
    </div>

    <div class="narrow-block">
        <progress id="global-progress" value="0" max="100"></progress>
    </div>

    <br/>
    <div id="media" class="upload-container"></div>
    <br/>
    <br/>

    <script>
        $('#preprocess_media_button').click(function () {
            preprocessMedia(this)
        });

        $('#upload_media_button').click(function () {
            uploadMedia(this)
        });

        $('#upload_as').on('change', function () {
            clearProxies()

            if ($(this).val() === 'target') {
                $("label[for='item_tags']").hide()
            } else {
                $("label[for='item_tags']").show()
            }
        });

        let thumbnailElement = $('#parent_thumbnail')
        let uuidElement = $('#parent_uuid')

        uuidElement.on('input', function () {
            tryLoadingThumbnail(uuidElement.val(), thumbnailElement)
        });

        $(document).ready(function () {
            tryLoadingThumbnail(uuidElement.val(), thumbnailElement)
        });
    </script>

{% endblock %}
