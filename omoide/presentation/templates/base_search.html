<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon"
          href="{{ url_for('static', path='favicon.ico') }}">
    <link type="text/css"
          href="{{ url_for('static', path='styles.css') }}"
          rel="stylesheet">
    <link type="text/css"
          href="{{ url_for('static', path='thirdparty/bootstrap/css/bootstrap.min.css') }}"
          rel="stylesheet">
    <script type="text/javascript"
            src="{{ url_for('static', path='code.js') }}"></script>
    <script type="text/javascript"
            src="{{ url_for('static', path='thirdparty/jquery-3.6.0.min.js') }}"></script>
    <script type="text/javascript"
            src="{{ url_for('static', path='thirdparty/bootstrap/js/bootstrap.min.js') }}"></script>
    {% block head %}{% endblock %}
    <title>Omoide</title>
    {%- if config.injection %}
        {{ config.injection|safe }}
    {% endif -%}
</head>

<body>
<div id="header">
    <div class="query-container">
        <a href="{{ url_for('app_home') + '?' + aim_wrapper.to_url_no_q() }}"
           title="Go to starting page"
           class="button qc-home">
            <img src="{{ request.url_for('static', path='ic_home_24px.svg') }}"
                 class="invert"
                 alt="Home icon"/>
            <span>Home</span>
        </a>

        <div id="guess" class="guess qc-input">
            <input id="query_element"
                   name="query"
                   type="search"
                   value="{{ aim_wrapper.query.raw_query or '' }}"
                   class="query_input"
                   autocomplete="off"
                   placeholder="Enter one or more tags here" autofocus/>
        </div>

        <a id="search_button"
           href="javascript:void(0)"
           title="Press to perform search"
           onclick="goSearch()"
           class="button qc-search">
            <img src="{{ request.url_for('static', path='ic_search_24px.svg') }}"
                 alt="Looking glass icon"/>
            <span>Search</span>
        </a>

        {% if block_ordered %}
            <span class="button-disabled qc-order">
                {% if aim_wrapper.ordered %}
                    <img src="{{ request.url_for('static', path='ic_sort_24px.svg') }}"
                         alt="Ordering is not supported in this section"/>
                    <span class="wide-text">&nbsp;Ordered</span>
                {% else %}
                    <img src="{{ request.url_for('static', path='ic_random_24px.svg') }}"
                         alt="Ordering is not supported in this section"/>
                    <span>Random</span>
                {% endif %}
            </span>
        {% else %}
            {% if aim_wrapper.ordered %}
                <a href="javascript:void(0)"
                   title="Show items ordered"
                   onclick="toggleOrdered()"
                   class="button qc-order">
                    <img src="{{ request.url_for('static', path='ic_sort_24px.svg') }}"
                         alt="Show items ordered"/>
                    <span>Ordered</span>
                </a>
            {% else %}
                <a href="javascript:void(0)"
                   title="Show items in random order"
                   onclick="toggleOrdered()"
                   class="button qc-order">
                    <img src="{{ request.url_for('static', path='ic_random_24px.svg') }}"
                         alt="Show items in random order"/>
                    <span>Random</span>
                </a>
            {% endif %}
        {% endif %}

        {% if block_nested %}
            <span class="button-disabled qc-nested">
                {% if aim_wrapper.nested %}
                    <img src="{{ request.url_for('static', path='ic_nested_on.svg') }}"
                         alt="Nesting is not supported in this section"/>
                    <span>Nested</span>
                {% else %}
                    <img src="{{ request.url_for('static', path='ic_nested_off.svg') }}"
                         alt="Nesting is not supported in this section"/>
                    <span>Flat</span>
                {% endif %}
            </span>
        {% else %}
            {% if aim_wrapper.nested %}
                <a href="javascript:void(0)"
                   title="Show only top level items"
                   onclick="toggleNested()"
                   class="button qc-nested">
                    <img src="{{ request.url_for('static', path='ic_nested_on.svg') }}"
                         alt="Show only top level items"/>
                    <span>Nested</span>
                </a>
            {% else %}
                <a href="javascript:void(0)"
                   title="Show albums same way as separate pages"
                   onclick="toggleNested()"
                   class="button qc-nested">
                    <img src="{{ request.url_for('static', path='ic_nested_off.svg') }}"
                         alt="Show albums same way as separate pages"/>
                    <span>Flat</span>
                </a>
            {% endif %}
        {% endif %}

        {% if block_paginated or False %}
            <span class="button-disabled qc-paged">
                <img src="{{ request.url_for('static', path='ic_paginated_on.svg') }}"
                     alt="Pagination is not supported in this section"/>
                {% if aim_wrapper.paged %}
                    <span>Paginated</span>
                {% else %}
                    <span>Dynamic</span>
                {% endif %}
            </span>
        {% else %}
            {% if aim_wrapper.paged %}
                <a href="javascript:void(0)"
                   title="Show items in statically rendered pages"
                   onclick="togglePaged()"
                   class="button qc-paged">
                    <img src="{{ request.url_for('static', path='ic_paginated_on.svg') }}"
                         alt="Show items in statically rendered pages"/>
                    <span>Paginated</span>
                </a>
            {% else %}
                <a href="javascript:void(0)"
                   title="Load items dynamically"
                   onclick="togglePaged()"
                   class="button qc-paged">
                    <img src="{{ request.url_for('static', path='ic_paginated_off.svg') }}"
                         alt="Load items dynamically"/>
                    <span>Dynamic</span>
                </a>
            {% endif %}
        {% endif %}

        {% if user.is_anon() %}
            <a href="{{ url_for('app_login') }}"
               title="Log in"
               class="button qc-login">
                <img src="{{ request.url_for('static', path='ic_perm_identity_24px.svg') }}"
                     alt="Login"/>
                <span>Login</span>
            </a>
        {% else %}
            <a href="{{ url_for('app_profile') }}"
               class="button qc-login">
                <img src="{{ request.url_for('static', path='ic_perm_identity_24px.svg') }}"
                     alt="Profile"/>
                <span>{{ user.name }}</span>
            </a>
        {% endif %}
    </div>

    {% if user.is_not_anon() %}
        <div class="menu-container">
            {% if current_item %}
                {% set parent_hint = current_item.uuid | string %}
            {% else %}
                {% set parent_hint = user.root_item | string %}
            {% endif %}

            <a href="{{ url_for('app_item_create', uuid=parent_hint) + '?' + aim_wrapper.to_url_no_q() }}"
               title="Create new item"
               class="button">
                <img src="{{ request.url_for('static', path='ic_create_new_folder_24px.svg') }}"
                     alt="Create"/>
                <span>Create</span>
            </a>

            <a href="{{ url_for('app_upload', uuid=parent_hint) + '?' + aim_wrapper.to_url_no_q() }}"
               title="Upload media"
               class="button">
                <img src="{{ request.url_for('static', path='ic_perm_media_24px.svg') }}"
                     alt="Upload"/>
                <span>Upload</span>
            </a>

            {% if current_item and current_item.owner_uuid|string == user.uuid|string %}
                <a href="{{ url_for('app_item_update', uuid=parent_hint) + '?' + aim_wrapper.to_url_no_q() }}"
                   class="button">
                    <img src="{{ request.url_for('static', path='ic_format_list_bulleted_24px.svg') }}"
                         alt="Edit"/>
                    <span>Edit</span>
                </a>

                <a href="{{ url_for('app_item_delete', uuid=parent_hint) + '?' + aim_wrapper.to_url_no_q() }}"
                   class="button">
                    <img src="{{ request.url_for('static', path='ic_delete_24px.svg') }}"
                         alt="Delete"/>
                    <span>Delete</span>
                </a>
            {% else %}
                <a href="{{ url_for('app_item_update', uuid=parent_hint) + '?' + aim_wrapper.to_url_no_q() }}"
                   class="button-disabled">
                    <img src="{{ request.url_for('static', path='ic_format_list_bulleted_24px.svg') }}"
                         alt="Edit"/>
                    <span>Edit</span>
                </a>

                <a href="{{ url_for('app_item_delete', uuid=parent_hint) + '?' + aim_wrapper.to_url_no_q() }}"
                   class="button-disabled">
                    <img src="{{ request.url_for('static', path='ic_delete_24px.svg') }}"
                         alt="Delete"/>
                    <span>Delete</span>
                </a>
            {% endif %}
        </div>
    {% endif %}

    {% block upper_body %}{% endblock %}

</div>

{% block body %}{% endblock %}

<script>
    $(document).ready(function () {
        let input = document.getElementById('query_element');
        let textLen = (input.value || '').length
        input.focus();
        input.setSelectionRange(textLen, textLen);

        let currentFocus = -1;

        input.addEventListener('keyup', function (e) {
            if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') {
                guessTag(this, '{{ request.url_for('api_suggest_tag') }}')
            }
        })

        input.addEventListener('keydown', function (e) {
            let cont = document.getElementById(this.id + 'autocomplete-list');
            let items = []
            if (cont) items = cont.getElementsByTagName('div');
            if (e.key === 'ArrowDown') {
                currentFocus++;
                currentFocus = addActiveGuess(items, currentFocus);
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                currentFocus = addActiveGuess(items, currentFocus);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocus > -1 && items && currentFocus < items.length) {
                    items[currentFocus].click();
                    currentFocus = -1
                } else {
                    goSearch()
                }
            }
        });

        document.addEventListener('click', function (e) {
            clearGuesses(e.target);
        })
    })
</script>

</body>
</html>
